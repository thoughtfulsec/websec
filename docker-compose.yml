services:
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    platform: linux/amd64
    networks:
      - app-network
    expose:
      - "8000"
    volumes:
      - ./app/data:/app/data
    environment:
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL:-http://localhost:8888/auth/google/callback}
      - SESSION_SECRET=${SESSION_SECRET}
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  modsecurity:
    image: owasp/modsecurity-crs:nginx-alpine
    platform: linux/amd64
    ports:
      - "8888:8080"
    networks:
      - app-network
    volumes:
      - ./nginx-config/custom-routes.conf:/etc/nginx/templates/conf.d/default.conf.template
    environment:
      - BACKEND=http://app:8000
      - PORT=8080
      - PROXY=1
      - PROXY_SSL=0
      - PROXY_SSL_VERIFY=off
      - PARANOIA=1
      - ANOMALY_INBOUND=5
      - ANOMALY_OUTBOUND=4
    depends_on:
      app:
        condition: service_healthy

networks:
  app-network:
    driver: bridge

