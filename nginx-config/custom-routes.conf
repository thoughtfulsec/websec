# Custom nginx configuration for ModSecurity demo
# This file overrides the default location blocks to provide
# different ModSecurity protection levels for different routes

server_tokens off;

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 8080 default_server;
    server_name localhost;
    set $always_redirect off;

    # Insecure route - ModSecurity DISABLED
    # This demonstrates what happens without WAF protection
    location /insecure {
        modsecurity off;
        
        client_max_body_size 0;
        
        # Add custom header to indicate no protection
        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "NONE" always;
        
        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Secure route - ModSecurity ENABLED
    # This demonstrates WAF protection in action
    location /secure {
        modsecurity on;

        client_max_body_size 0;

        # Add custom header to indicate protection is active
        add_header X-ModSecurity-Status "ENABLED" always;
        add_header X-Route-Protection "OWASP-CRS" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # OAuth routes - ModSecurity DISABLED
    # OAuth callback URLs contain parameters that trigger false positives
    # (e.g., Google's scope parameter contains ".profile" which triggers LFI detection)
    location /auth/ {
        modsecurity off;

        client_max_body_size 0;

        # Add custom header to indicate OAuth route
        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "OAUTH" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Logout route - ModSecurity DISABLED (session management)
    location /logout {
        modsecurity off;

        client_max_body_size 0;

        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "SESSION" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Default location for all other routes (ModSecurity enabled)
    location / {
        modsecurity on;
        
        client_max_body_size 0;

        if ($always_redirect = on) {
            return 301 https://$host$request_uri;
        }

        include includes/cors.conf;
        include includes/proxy_backend.conf;

        index index.html index.htm;
        root /usr/share/nginx/html;
    }

    # Health check and common locations
    include includes/location_common.conf;
}

# SSL server configuration (optional, keeping for completeness)
server {
    listen 8443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/conf/server.crt;
    ssl_certificate_key /etc/nginx/conf/server.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;
    ssl_session_tickets off;

    ssl_dhparam /etc/ssl/certs/dhparam-2048.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    ssl_stapling on;
    ssl_stapling_verify on;

    ssl_verify_client off;
    ssl_verify_depth 1;

    # Insecure route - ModSecurity DISABLED (SSL)
    location /insecure {
        modsecurity off;
        
        client_max_body_size 0;
        
        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "NONE" always;
        
        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Secure route - ModSecurity ENABLED (SSL)
    location /secure {
        modsecurity on;

        client_max_body_size 0;

        add_header X-ModSecurity-Status "ENABLED" always;
        add_header X-Route-Protection "OWASP-CRS" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # OAuth routes - ModSecurity DISABLED (SSL)
    location /auth/ {
        modsecurity off;

        client_max_body_size 0;

        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "OAUTH" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Logout route - ModSecurity DISABLED (SSL)
    location /logout {
        modsecurity off;

        client_max_body_size 0;

        add_header X-ModSecurity-Status "DISABLED" always;
        add_header X-Route-Protection "SESSION" always;

        include includes/cors.conf;
        include includes/proxy_backend.conf;
    }

    # Default location (SSL)
    location / {
        modsecurity on;
        
        client_max_body_size 0;

        include includes/cors.conf;
        include includes/proxy_backend.conf;

        index index.html index.htm;
        root /usr/share/nginx/html;
    }

    include includes/location_common.conf;
}

